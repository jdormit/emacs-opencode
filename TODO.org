#+TITLE: Emacs OpenCode TODO

* TODO completion-at-point in session buffer input
- slach commands
- @agent
- file paths, once @file is supported
* TODO Support @file mentions (inlines file contents into prompt)
* TODO Support !shell command mentions (inlines shell command output into prompt)
* TODO Fix unclear wording for permission requests
E.g. "OpenCode wants to rg foobar .*" or "OpenCode wants to foo/bar/baz.txt". What do those mean?
* TODO Overview buffers (sessions/projects)
- List-returning functions for sessions/projects.
- Thin rendering buffer(s) + completion integration.

* TODO Session management commands
- Load session, fork, delete, rename.

* TODO Display tool call errors in the session buffer
* TODO Support showing reasoning blocks
* IN PROGRESS Address poor performance of SSE buffer/event dispatch
- Batch message renders (idle timer) to reduce repeated `message.part.updated` redraws.
- Throttle tool part updates; render on status change or completion.
- Avoid full re-render per part; add incremental text updates where possible.
  - update: tried this, it didn't seem to improve performance at all and introduced more complexity around newline handling
- Throttle header/spinner updates during streaming bursts.
- Queue SSE handlers to drain in-order with fewer timers.
* TODO Add newline before "block level" message parts if they are the first part of the message and there isn't a blank line above
* TODO Add support for managing LLM providers/connections
* TODO Font lock in session buffers
Should syntax highlight markdown and display diffs from the patch tool with diff syntax highlighting.
* DONE Support slash commands in the session buffer
CLOSED: [2026-02-03 Tue 16:46]
* DONE Show token usage metadata in session buffer
CLOSED: [2026-01-31 Sat 00:45]
* DONE Show shell command being run in shell tool call
CLOSED: [2026-01-30 Fri 16:52]
* DONE Sometimes multiple "Read" tool calls end up on the same line
CLOSED: [2026-01-30 Fri 13:42]
* DONE Handle diff in edit tool calls
CLOSED: [2026-01-30 Fri 16:35]
- Show the diff after each edit like the TUI

* DONE Make the session buffer look pretty
CLOSED: [2026-01-30 Fri 15:12]
With colors!

* DONE Handle sub-agents/sub-sessions
CLOSED: [2026-01-30 Fri 13:13]
* DONE Buffer-aware commands
CLOSED: [2026-01-30 Fri 13:12]
** DONE Ask about region/point/file context.
CLOSED: [2026-01-29 Thu 17:04]
** DONE Apply edits to selection or buffer.
CLOSED: [2026-01-30 Fri 13:12]
** DONE send context to existing session buffers, not just new ones
CLOSED: [2026-01-30 Fri 13:12]

The interface for this is something like: an opencode-ask command, which when run in a buffer asks for a prompt, then sends that prompt to a new opencode session for the project the buffer is in (prompting for a directory to run opencode in if the buffer is not in a project).

The prompt will embed some context around point (or the region if there is one).

This will require building out some additional functionality:
- a function to open a new opencode session with a prompt that intelligently finds/starts the opencode connection
- (optional) a minor mode with keybindings for the in-buffer contextual commands

* DONE Make open-session reuse the existing session buffer if there is one
CLOSED: [2026-01-30 Fri 12:45]
* DONE Give connections a unique port so we can have multiple open connections
CLOSED: [2026-01-30 Fri 12:41]
* DONE Emacs tool integration (MCP)
CLOSED: [2026-01-30 Fri 01:08]
- Expose Emacs access to OpenCode tools.

* DONE Handle question functionality
CLOSED: [2026-01-29 Thu 14:19]
- question.asked SSE
- should prompt the user in emacs via completing-read, with an option to type your own answer

Example SSE:
#+begin_src
data: {"type":"question.asked","properties":{"id":"que_c055308d8001R7q6izrlXP4nzo","sessionID":"ses_3faad41e4ffe8JF0e2lLG0y24o","questions":[{"question":"For tool parts rendering, do you want them inline with message text or as a distinct block (e.g., `[tool]` header + status/output)?","header":"Tool UI","options":[{"label":"Distinct block (Recommended)","description":"Render tool parts as separate block below message content."},{"label":"Inline text","description":"Mix tool info into the message text flow."},{"label":"Other","description":"Specify custom formatting or placement."}]},{"question":"Should tool output be fully rendered or summarized (e.g., first line + truncated)?","header":"Output","options":[{"label":"Summarized (Recommended)","description":"Show brief output with truncation indicator."},{"label":"Full output","description":"Render full tool output in buffer."},{"label":"Other","description":"Specify custom truncation rules."}]}],"tool":{"messageID":"msg_c0552ed20002Z70IEWVcsE36dF","callID":"call_twQ1UXrHcS2qpL0epHDBKXsw"}}}
#+end_src
* DONE Handle permission requests
CLOSED: [2026-01-29 Thu 10:39]
SSE shape:
#+begin_src
data: {"type":"permission.asked","properties":{"id":"per_c07cae9e70018qPP3AI5xni7y0","sessionID":"ses_3f83afb92ffeWdWJLvwmUlnx0e","permission":"external_directory","patterns":["/Users/jdormit/opencode/*"],"metadata":{"filepath":"/Users/jdormit/opencode","parentDir":"/Users/jdormit/opencode"},"always":["/Users/jdormit/opencode/*"],"tool":{"messageID":"msg_c07cad1970027lMlJoSlY7t8wi","callID":"call_TeppexgaMwOtZxfQpX3miTJN"}}}
#+end_src
* DONE Add command to send interrupt to opencode
CLOSED: [2026-01-29 Thu 00:15]
* DONE Current Goal: Vertical Slice (Launch → Chat → Stream)
** DONE Start opencode serve subprocess in CWD
- Spawn opencode with --serve (or opencode serve) and capture host/port.
- Track process lifecycle and allow stop/restart.

** DONE Implement minimal HTTP client (request.el)
- Base URL, health check (/global/health).
- Create session (/session).
- Send prompt async (/session/:id/prompt_async).

** DONE Implement SSE stream handling
- Connect to /event for the active session.
- Parse SSE frames and extract message parts.
- Dispatch events to UI and handler registry.

** DONE Create opencode-session mode
- Define major mode and buffer layout.
- Buffer naming uses OpenCode session title.
- Input submission command to send prompts.
- Append streaming output as it arrives.

** DONE Implement M-x opencode command
- Orchestrate server start, health check, session create.
- Open chat buffer and connect stream.

** DONE Implement shutdown command
- Interactive completion over active connections.
- Stop process and clean registry.

* DONE Handle todo list functionality
CLOSED: [2026-01-28 Wed 22:40]
- todo.updated SSE
- should show the todo list with done items checked off

Example SSE:
#+begin_src
data: {"type":"todo.updated","properties":{"sessionID":"ses_3fabc1211ffecnI8SVTEFxUGDf","todos":[{"id":"1","content":"Review session/mode SSE handling spots","status":"completed","priority":"high"},{"id":"2","content":"Design plan/build mode state + header","status":"in_progress","priority":"high"},{"id":"3","content":"Plan tool-part rendering + diff display","status":"pending","priority":"high"},{"id":"4","content":"Plan file event handlers + buffer revert","status":"pending","priority":"high"},{"id":"5","content":"Update TODO.org milestones","status":"pending","priority":"medium"}]}}
#+end_src
* DONE SSE event handlers API
CLOSED: [2026-01-28 Wed 10:54]
- Define a handler registry for event types.
- Dispatch SSE events to named Emacs hooks.

* DONE Auto-reload edited buffers
CLOSED: [2026-01-28 Wed 12:53]
- Register global handlers for file.edited and file.watcher.updated.
- Revert visiting buffers when their file is updated.

* DONE Render tool parts
CLOSED: [2026-01-28 Wed 11:10]
- Render message parts with type "tool" in the session buffer.
- Include tool name, status, and output summary.

* DONE Agent selection + header indicator
CLOSED: [2026-01-28 Wed 12:53]
- Track available agents on connection.
- Buffer-local agent state in session mode (select + cycle commands).
- Show active agent in session header.
- Send agent name with prompt requests.
